# NetworkPolicy for user environment isolation
# Provides security isolation while allowing necessary communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: user-environment-isolation
  namespace: tesslate-user-environments
  labels:
    app: tesslate
    tier: user-workloads
spec:
  # Apply to all pods in the user environments namespace
  podSelector: {}

  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow ingress from main tesslate namespace (backend API for file operations)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: tesslate

  # Allow ingress from ingress-nginx namespace (for web traffic routing)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx

  # Allow ingress from within the same namespace (pod-to-pod communication if needed)
  - from:
    - podSelector: {}

  egress:
  # Allow DNS resolution (required for all networking)
  - to: []
    ports:
    - protocol: UDP
      port: 53

  # Allow external HTTPS (npm packages, APIs, etc.)
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80

  # Deny all other traffic (implicit)
  # This prevents user pods from communicating with each other
  # and blocks access to internal cluster services